##
library(DNAshape)

##do shape prediction
ifile <- file.path(path.package("DNAshape"), "v2.6_noSim/Example/Dickerson/seq.txt")
predictDNAShapes(ifile)

##plot single shape
ofiles <- list.files(path=dirname(ifile), pattern="seq")[-1]
ofiles
i <- 1
shape <- readShape(file.path(dirname(ifile), ofiles[i]))
shapeType <- gsub("seq.txt.", "", basename(ofiles[i]))

library(Biostrings)
sequence <- readDNAStringSet(ifile, format="fasta")
sequence

plotShape(shape, sequence, shapeType=shapeType)

##plot all shapes at once
plotShapes(ifile)

##Parker figure 1G

##generate all kmers sequences for given alphabet
generateAllKmers <- function(k, alphabet=c("A", "C", "G", "T"))
  {
    require(Biostrings)
    L <- length(alphabet)    
    kmers <- matrix(NA, nrow=L^k, ncol=k)    
    for(i in 1:k)   
      kmers[,i] <- rep(alphabet, each=L^(i-1))    
    DNAStringSet(apply(kmers, 1, paste0, collapse=""))    
  }

generateAllKmers <- function(k, alphabet=c("A", "C", "G", "T"))
  {
    require(Biostrings)
    L <- length(alphabet)    
    kmers <- matrix(NA, nrow=L^k, ncol=k)    
    for(i in 1:k)   
      kmers[,i] <- rep(alphabet, each=L^(i-1))

    ##swap first column to the middle
    col1 <- kmers[,1]
    col2 <- kmers[,floor(k/2)+1]

    kmers[,1] <- col2
    kmers[,floor(k/2)+1] <- col1
    
    DNAStringSet(apply(kmers, 1, paste0, collapse=""))    
  }

kmer7 <- generateAllKmers(7, alphabet=c("A", "C", "G", "T"))
kmer7
kmer11 <- generateAllKmers(11, alphabet=c("A", "C", "G", "T"))
kmer11

writeXStringSet(kmer7, file="kmer7seq.txt")

ifile <- file.path(getwd(), "kmer7seq.txt")
predictDNAShapes(ifile)

ofiles <- list.files(path=dirname(ifile), pattern="kmer7seq")[-1]
ofiles
i <- 2

##too slow use linux
##shape <- readShape(file.path(dirname(ifile), ofiles[i]))

file <- file.path(dirname(ifile), ofiles[i])
shape <- read.table(pipe(paste("sed '/>/d'", file)), sep=",")
dim(shape)

str(shape)
dim(shape)
head(shape)

reducedShape <- shape[, c(-c(1:2), -c((ncol(shape)-1):ncol(shape)))]
dim(reducedShape)






shapeType <- gsub("seq.txt.", "", basename(ofiles[i]))

library(Biostrings)
sequence <- readDNAStringSet(ifile, format="fasta")
sequence


tbl <- read.table(file.path("/home/mvaniterson/R/BIOS/rscripts/motifEnrichmentTableGlobaleQTLsFDR0.05top10.txt"), sep="\t", header=TRUE)

tbl[,4:7] <- signif(tbl[,4:7], 2)

write.table(tbl[order(tbl$p.adj),], file = file.path("/home/mvaniterson/R/BIOS/rscripts/motifEnrichmentTableGlobaleQTLsFDR0.05top10.md"), sep="||", row.names=FALSE, quote=FALSE)


ifile <- "sequences.fa"
predictDNAShapes(ifile)
ofiles <- list.files(path=dirname(ifile), pattern="sequences")[-1]
ofiles

i <- 2
shape <- readShape(ofiles[i])
shape <- t(as.data.frame(shape))
shape

shapeType <- gsub("seq.txt.", "", basename(ofiles[i]))
library(Biostrings)
sequence <- readDNAStringSet(ifile, format="fasta")
sequence

plotShape(shape, sequence[[1]], shapeType=shapeType)

matplot(1:21, t(shape), type="b", pch=1, col=rep(1:2, each=4), lty=rep(1:4, 2))
plotShape(shape, shapeType=shapeType)

